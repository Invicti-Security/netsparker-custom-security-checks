/* 
*  This Singular Security Check script was generated by Invicti Standard 23.3.0.39944, at 3/24/2023 12:57:12 PM 
*  For more information about Custom Script Checks and samples, please refer to documentation: 
*  https://www.invicti.com/support/custom-security-checks-scripting/ 
*/ 

var attacks = [
    {
        id: '6160b0c4-ee2f-47e0-b92c-638f743b7f06',
        name: 'VMware vSphere Client (HTML5) - Remote Code Execution'
    }
];

function analyze(response) {
    logUI("CVE-2021-21985 custom script started!");
    var re = /(https?:\/\/)([^:^\/]*)(:?\d*)(.*)?/;
    var capture = response.Uri.match(re);
    var host = capture[2].toString() + capture[3].toString();
    var url = capture[1].toString() + host
    var body = "{\"methodInput\":[{\"type\":\"ClusterComputeResource\",\"value\": null,\"serverGuid\": null}]}";
    var length = body.length;

    var raw =  `POST /ui/h5-vsan/rest/proxy/service/com.vmware.vsan.client.services.capability.VsanCapabilityProvider/getClusterCapabilityData HTTP/1.1
Host: ${host}
Accept: */*
Content-Type: application/json
Content-Length: ${length}

${body}`;

    var response = invicti.requestRaw(url, raw, false);

    if (response.Body.indexOf('{"result":{"isDisconnected":')) {
        logUI("CVE-2021-21985 custom script ended!");
        return new Vulnerability("00e1d920-8bfd-42b5-8ef3-1924507547bc");
    }   
    logUI("CVE-2021-21985 custom script ended!");
}