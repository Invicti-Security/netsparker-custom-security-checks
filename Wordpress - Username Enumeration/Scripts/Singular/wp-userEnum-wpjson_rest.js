/* 
*  This Singular Security Check script was generated by Invicti Standard 22.11.0.38744, at 03/01/2023 11:07:42 
*  For more information about Custom Script Checks and samples, please refer to documentation: 
*  https://www.invicti.com/support/custom-security-checks-scripting/ 
*/

var attacks = [
    {
        id: 'd452035a-9c61-480d-87b2-0b0da7581fef',
        name: 'Wordpress - Username Enumeration via JSON API',
    }
];

function checkJsonApiResponse(url) {
    const request = new Request(url);
    const restResponse = netsparker.request(request)
    if (restResponse.StatusCode == 200) {
        const usersMatch = restResponse.body.match(/\"id\":\d+,\"name\":\"(?<name>.*?)\"/gm)
        if (usersMatch != null) {
            return usersMatch;
        }
    } 
}

function createVulnerability(users) {
    const vulnerability = new Vulnerability('81efaf18-7056-4611-9ac5-08811171cc04')
    for (i=0; i<users.length;i++) {
        var username = users[i].match(/\"id\":\d+,\"name\":\"(.*?)\"/)
        vulnerability.CustomFields.add(`user` + i +":", username[1].substring(0,3) + "*****")
    }
    return vulnerability;
}

function analyze(response) {
    var url = response.Uri.toString() + 'wp-json/wp/v2/users'
    var match = checkJsonApiResponse(url)
    if (match != null) {
        const vulnerability = createVulnerability(match)
        return vulnerability;    
    } else {
        url = response.Uri.toString() + "?rest_route=/wp/v2/users"
        match = checkJsonApiResponse(url)
        if (match != null) {
            const vulnerability = createVulnerability(match)
            return vulnerability;
        }
    }
}