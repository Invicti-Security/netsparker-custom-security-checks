/* 
*  This Singular Security Check script was generated by Invicti Standard 22.11.0.38744, at 03/01/2023 11:07:42 
*  For more information about Custom Script Checks and samples, please refer to documentation: 
*  https://www.invicti.com/support/custom-security-checks-scripting/ 
*/

var attacks = [
    {
        id: '622ef304-15cd-482c-8dc1-486ac456023a',
        name: 'Wordpress - Username Enumeration via RSS Feed',
    }
];

function checkRssFeedResponse(url) {
    const request = new Request(url);
    const restResponse = netsparker.request(request)
    if (restResponse.StatusCode == 200) {
        const usersMatch = restResponse.body.match(/\<dc:creator\>\<!\[CDATA\[(?<name>.*?)\]\]\>\<\/dc:creator\>/gm)
        if (usersMatch != null) {
            return usersMatch;
        }
    } 
}

function createVulnerability(users) {
    const vulnerability = new Vulnerability('69bee03c-2bd4-4c16-8b35-8b07ca1e3564 ')
    for (i=0; i<users.length;i++) {
        var username = users[i].match(/\<dc:creator\>\<!\[CDATA\[(.*?)\]\]\>\<\/dc:creator\>/)
        vulnerability.CustomFields.add(`user` + i +":", username[1].substring(0,3) + "*****")
    }
    return vulnerability;
}

function analyze(response) {
    var url = response.Uri.toString() + 'feed'
    var match = checkRssFeedResponse(url)
    if (match != null) {
        const vulnerability = createVulnerability(match)
        return vulnerability;
    } else {
        url = response.Uri.toString() + '?feed=rss'
        match = checkRssFeedResponse(url)
        if (match != null) {
            const vulnerability = createVulnerability(match)
            return vulnerability;
        }
    } 
}